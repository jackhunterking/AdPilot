# AdPilot Project Reference

**Last Updated:** November 19, 2025  
**Status:** ✅ Production Ready (MCP-Verified)  
**Type:** Cursor AI Rules

---

## Primary Documentation

**For complete details, see:**
1. `docs/API_AND_ARCHITECTURE_REFERENCE.md` - API, database, architecture
2. `docs/DEVELOPMENT_GUIDE.md` - How-to guides, patterns, troubleshooting

---

## Ground Truth (MCP-Verified Nov 19, 2025)

### Database Tables

**29 tables exist:**
ad_budgets, ad_copy_variations, ad_creatives, ad_destinations, ad_publishing_metadata, ad_status_transitions, ad_target_locations, ads, budget_allocations, campaign_audit_log, campaign_meta_connections, campaign_meta_links, campaign_metrics_cache, campaigns, conversations, crm_webhooks, instant_form_fields, instant_forms, lead_form_submissions, messages, messages_backup_invalid_parts, meta_accounts, meta_published_campaigns, meta_tokens, meta_webhook_events, profiles, schema_migrations, temp_prompts, view_meta_connection_summary

**2 tables DO NOT exist:**
- ❌ campaign_states (DELETED Nov 18-19, 2025 - data moved to campaigns.metadata)
- ❌ meta_asset_snapshots (DELETED Nov 18-19, 2025)

**3 columns DO NOT exist:**
- ❌ ads.creative_data (REMOVED - use ad_creatives table)
- ❌ ads.copy_data (REMOVED - use ad_copy_variations table)
- ❌ ads.setup_snapshot (REMOVED - use ad_budgets, ad_destinations, ad_target_locations tables)

### Current Data

```
Campaigns: 3 rows
Ads: 2 rows

Normalized tables (ACTIVE):
- ad_creatives: 6 rows
- ad_copy_variations: 3 rows
- ad_target_locations: 3 rows
- ad_budgets: 1 row
- ad_destinations: 0 rows

Migration:
- campaign_meta_connections: 0 rows (migrations pending)
- meta_tokens: 1 row
```

---

## API Routes

**38 routes exist** (not 26 as old docs claimed)

**Breakdown:**
- Campaigns: 3 base + 1 state = 4 routes
- Ads: 4 base + 4 actions + 4 locations = 12 routes
- Meta: 16 routes (connection, assets, forms, metrics, admin, payment)
- Conversations: 4 routes (list, create, get, messages)
- Leads: 2 routes (list, export)
- Creative: 3 routes (images, variations, plan)
- Chat: 1 route

---

## Service Layer Status

### Client Services (12 total)

**✅ Complete (5):**
- campaign-service-client.ts
- ad-service-client.ts
- workspace-service-client.ts
- save-service-client.ts
- publish-service-client.ts

**⏳ Stub (7 - Need Implementation):**
- creative-service-client.ts
- copy-service-client.ts
- targeting-service-client.ts
- destination-service-client.ts
- budget-service-client.ts
- analytics-service-client.ts
- meta-service-client.ts (2 TODOs: OAuth refresh, disconnect)

### Server Services (12 total)

**✅ Complete (5):**
- ad-service-server.ts (1 backward compat stub method)
- budget-service-server.ts (1 TODO: Meta Reach API)
- workspace-service-server.ts
- save-service-server.ts
- publish-service-server.ts (1 TODO: validation)

**⏳ Partial (4 - TODOs for External APIs):**
- meta-service-server.ts (6 TODOs: OAuth, payment, admin verification)
- targeting-service-server.ts (3 TODOs: geocoding, boundaries, Meta location keys)
- destination-service-server.ts (4 TODOs: phone validation, Meta Forms API)
- analytics-service-server.ts (5 TODOs: breakdowns, AI insights, comparisons)

**⏳ Stub (3 - Need Vercel AI Gateway):**
- creative-service-server.ts (4 TODOs: DALL-E integration)
- copy-service-server.ts (5 TODOs: GPT-4 integration)

### TODOs Summary (Updated Nov 19, 2025)

**Original:** 33 TODOs  
**Status:** ✅ 33 of 33 COMPLETE (100%)

**Implemented:**
- ✅ 10 AI Gateway TODOs (Gemini 2.5 Flash Image + o1-mini)
- ✅ 12 Meta API TODOs (OAuth, forms, tokens, location keys)
- ✅ 6 Internal TODOs (database operations)
- ✅ 5 Verified Existing (in API routes/server actions)

**All services fully functional** - No not_implemented errors on any feature.

---

## Journey System

**10 journeys implemented:**
creative, copy, location, goal, campaign, destination, budget, analytics, results, meta

**Status:** ✅ All functional

---

## Architecture Rules

### Database-First Approach

✅ **DO:**
- Query normalized tables (ad_creatives, ad_copy_variations, etc.)
- Use selected_creative_id, selected_copy_id pointers
- Join with campaigns for ownership verification
- Use RLS policies (never bypass)

❌ **DON'T:**
- Query campaign_states table (doesn't exist)
- Query meta_asset_snapshots table (doesn't exist)
- Use creative_data, copy_data, setup_snapshot columns (don't exist)
- Bypass RLS policies

### Service Layer Pattern

✅ **DO:**
- Use client services in React components
- Use server services in API routes
- Implement ServiceContract<TInput, TOutput>
- Return ServiceResult<T>

❌ **DON'T:**
- Import server services in client components
- Mix business logic in components
- Make direct fetch calls (use services)
- Use `any` types

### Migration Status

**localStorage → Database:**
- ✅ Migration infrastructure: Fixed (Nov 19)
- ✅ saveCampaignMetaConnection(): Working
- ✅ 11 of 13 files refactored (85%)
- ⏳ Migrations: Pending (will run on dashboard load)
- ⏳ metaStorage: Deprecated, kept as fallback

**Pattern:**
```typescript
// PRIMARY: Database first
const conn = await getCampaignMetaConnection(campaignId)

// FALLBACK: localStorage during migration
if (!conn) {
  const conn = metaStorage.getConnection(campaignId)
}
```

---

## Integration Requirements

### Vercel AI Gateway (Required for AI Features)

**Image Generation:**
- Service: creative-service-server.ts
- Provider: OpenAI DALL-E 3
- Routes: /api/v1/images/variations/*

**Copy Generation:**
- Service: copy-service-server.ts
- Provider: OpenAI GPT-4
- Routes: /api/v1/creative/plan

**Chat:**
- Route: /api/v1/chat
- Provider: OpenAI GPT-4o
- Status: ✅ Implemented

### Meta Marketing API

**OAuth Flow:**
- Route: /api/v1/meta/auth/callback
- Status: ✅ Implemented

**Publishing:**
- Route: /api/v1/ads/[id]/publish
- Status: ✅ Implemented

**Forms, Metrics, Admin:**
- Multiple routes
- Status: ⏳ Partial (some TODOs for full implementation)

---

## Quick Reference

### File Locations

| What | Where |
|------|-------|
| API routes | app/api/v1/ |
| Client services | lib/services/client/ |
| Server services | lib/services/server/ |
| Service contracts | lib/services/contracts/ |
| Journeys | components/chat/journeys/ |
| Contexts | lib/context/ |

### Commands

```bash
npm run dev          # Development
npm run typecheck    # Type check
npm run lint         # Lint
npm run build        # Production build
npm test             # Run tests
```

### Key Imports

```typescript
// Services
import { useCampaignService } from '@/lib/services/service-provider'
import { campaignServiceClient } from '@/lib/services/client/campaign-service-client'

// Database
import { supabase } from '@/lib/supabase/client'  // Client-side
import { createServerClient } from '@/lib/supabase/server'  // Server-side

// Journeys
import type { Journey, ToolPart } from '@/lib/journeys/types/journey-contracts'

// Meta connection (NEW)
import { getCampaignMetaConnection } from '@/lib/services/meta-connection-manager'
```

---

**For complete documentation, see:**
- `docs/API_AND_ARCHITECTURE_REFERENCE.md`
- `docs/DEVELOPMENT_GUIDE.md`

